# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  prep:
    name: Prepare Build
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Prepare
        id: prep
        run: |
          BUILD_ID=$(echo $GITHUB_SHA | head -c7)
          echo ::set-output name=build_id::${BUILD_ID}
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true
      - name: Cache Docker Layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-multi-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-multi-buildx
      - name: Build Workspace Image
        uses: docker/build-push-action@v2
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: .devcontainer/Dockerfile
          target: workspace
          tags: alz-workspace:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,mode=max,dest=/tmp/.buildx-cache-new
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
        
  lint:
    name: Lint
    needs: prep
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true
      - name: Cache Docker Layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-multi-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-multi-buildx
      - name: Run lint stage
        uses: docker/build-push-action@v2
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: .devcontainer/Dockerfile
          target: lint
          cache-from: type=local,src=/tmp/.buildx-cache

  securityScan:
    name: Security Scan
    needs: prep
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true
      - name: Cache Docker Layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-multi-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-multi-buildx
      - name: Run security scan stage
        uses: docker/build-push-action@v2
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: .devcontainer/Dockerfile
          target: scan
          cache-from: type=local,src=/tmp/.buildx-cache
#       - name: Lint
#         run: docker build --target lint -f .devcontainer/Dockerfile .

  build:
    name: Build Artifact
    needs: [lint, securityScan]
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          install: true
      - name: Cache Docker Layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-multi-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-multi-buildx
      - name: Run build stage
        uses: docker/build-push-action@v2
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: .devcontainer/Dockerfile
          target: workspace
          tags: alz-workspace:latest
          load: true
          cache-from: type=local,src=/tmp/.buildx-cache
      - name: Build
        run: |
          docker run -d -v $GITHUB_WORKSPACE:/workspace alz-workspace:latest make build
          ls -al
      - name: Archive build artifact
        uses: actions/upload-artifact@v2
        with:
          name: dist
          path: dist
          retention-days: 1
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

#   publish:
#     name: Publish
#     needs: build
#     runs-on: ubuntu-20.04
#     steps:
#       - name: Download build artifact
#         uses: actions/download-artifact@v2
#       - name: Move Makefile
#         run: |
#           mv dist/Makefile Makefile
#       - name: Set AWS credentials
#         uses: aws-actions/configure-aws-credentials@v1
#         with:
#           aws-region: us-east-1
#           aws-access-key-id: ${{ secrets.CICD_AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.CICD_AWS_SECRET_ACCESS_KEY }}
#           role-to-assume: CICDServiceRole
#       - name: Publish release artifact
#         run: |
#           BUILD_ID=$(echo $GITHUB_SHA | head -c7)
#           BRANCH_ARR=($(echo "$GITHUB_REF" | tr '/' '\n'))
#           VERSION=$(echo "$BRANCH_ARR[4]")
#           ls -al dist
#           zip -r snapshot.zip dist/
#           aws s3 cp snapshot.zip s3://com.laudio.releases/infrastructure/aws-landing-zone/$VERSION-$BUILD_ID.zip
          
